# 活动报名系统架构设计文档

## 1. 系统架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                               前端层                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                用户界面 (React/Vue)                                │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                    │ HTTP/HTTPS                                          │
└────────────────────┼─────────────────────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            API网关层                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                API Gateway (Kong/Zuul)                              │ │
│  │  - 路由转发      - 负载均衡      - 认证授权      - 限流熔断          │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                    │ HTTP/HTTPS                                          │
└────────────────────┼─────────────────────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            微服务层                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐                 │
│  │ 用户微服务   │  │ 活动微服务  │  │  报名微服务     │                 │
│  │ - 用户管理   │  │ - 活动管理  │  │ - 报名管理      │                 │
│  │ - 认证授权   │  │ - 活动发布  │  │ - 报名统计      │                 │
│  └─────────────┘  └─────────────┘  └──────────────────┘                 │
│                    │ gRPC                                               │
└────────────────────┼─────────────────────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            数据层                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐                 │
│  │ 用户数据库   │  │ 活动数据库  │  │  报名数据库     │                 │
│  │ (MySQL)     │  │ (MySQL)     │  │ (MySQL Sharding) │                 │
│  └─────────────┘  └─────────────┘  └──────────────────┘                 │
│                    │ Redis                                              │
└────────────────────┼─────────────────────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            中间件层                                      │
│  ┌─────────────┐  ┌──────────────────┐                                  │
│  │   Redis     │  │   Kafka/RabbitMQ │                                  │
│  │ - 缓存      │  │ - 消息队列      │                                  │
│  └─────────────┘  └──────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 各组件职责与交互方式

| 组件          | 职责说明                                                                 | 交互方式                          |
|---------------|--------------------------------------------------------------------------|-----------------------------------|
| 前端层        | 提供用户界面，实现活动浏览、报名、个人中心等功能                         | HTTP/HTTPS 与 API 网关通信        |
| API 网关      | 统一入口，负责路由转发、负载均衡、认证授权、限流熔断等                   | HTTP/HTTPS 与前端和微服务通信     |
| 用户微服务    | 负责用户管理、认证授权、用户信息维护                                     | gRPC 与其他微服务通信             |
| 活动微服务    | 负责活动发布、活动管理、活动信息维护                                     | gRPC 与其他微服务通信             |
| 报名微服务    | 负责报名管理、报名统计、报名状态维护                                     | gRPC 与其他微服务通信             |
| 数据库        | 存储用户、活动、报名等核心数据                                           | JDBC 与微服务通信                 |
| Redis 缓存    | 缓存活动信息、热点数据，提高访问速度                                     | Redis 客户端与微服务通信          |
| 消息队列      | 实现异步报名处理，解耦系统，防止数据库雪崩                               | 生产者-消费者模式与微服务通信     |

### 1.3 数据库分库分表策略

#### 1.3.1 分库策略

- **用户数据库**：按用户ID范围进行分库，每100万用户为一个数据库实例
- **活动数据库**：按活动创建时间进行分库，每6个月的数据为一个数据库实例
- **报名数据库**：按活动ID进行分库，每个数据库实例处理1000个活动的报名数据

#### 1.3.2 分表策略

- **用户表**：按学院ID进行分表，每个学院对应一个用户表
- **活动表**：按活动类型进行分表，不同类型的活动存储在不同的表中
- **报名表**：按活动ID进行分表，每个活动对应一个独立的报名表

## 2. 性能与安全优化

### 2.1 高并发场景瓶颈分析

- **报名瞬间流量激增**：当热门活动开始报名时，短时间内会有大量用户同时提交报名请求，导致数据库压力过大
- **活动信息频繁查询**：用户浏览活动列表时，会频繁查询活动信息，增加数据库负担
- **报名数据一致性**：需要确保同一用户不会重复报名同一活动，同时保证活动报名人数不超过限制

### 2.2 缓存策略设计

#### 2.2.1 活动信息缓存
- **缓存内容**：活动基本信息、活动详情、活动报名状态
- **缓存过期时间**：活动信息缓存5分钟，活动报名状态缓存1分钟
- **缓存更新机制**：活动信息变更时，主动更新缓存并设置过期时间

#### 2.2.2 热点数据预热
- **预热时机**：活动发布前1小时
- **预热内容**：热门活动的详细信息、报名规则
- **预热方式**：通过定时任务将热点活动数据加载到Redis缓存

### 2.3 异步报名处理

```
┌─────────────────┐     ┌───────────────┐     ┌─────────────────┐
│  用户报名请求   │────▶│   消息队列     │────▶│  异步处理服务   │
└─────────────────┘     └───────────────┘     └─────────────────┘
                                                  │
                                                  ▼
                                          ┌─────────────────┐
                                          │   数据库更新     │
                                          └─────────────────┘
```

- **消息队列选择**：Kafka，支持高吞吐量和持久化存储
- **处理流程**：
  1. 用户提交报名请求
  2. 系统将报名请求写入消息队列
  3. 异步处理服务从队列中读取请求并处理
  4. 更新数据库报名状态
  5. 通过WebSocket实时通知用户报名结果

### 2.4 防止刷单机制

#### 2.4.1 限流策略
- **令牌桶算法**：对每个用户ID或IP地址设置限流规则
- **限流阈值**：单用户每秒最多3个报名请求，单IP每秒最多10个请求
- **实现方式**：在API网关层使用Redis实现分布式限流

#### 2.4.2 验证码机制
- **使用场景**：热门活动报名、短时间内多次报名请求
- **验证码类型**：图形验证码、短信验证码
- **验证流程**：
  1. 用户请求报名
  2. 系统要求输入验证码
  3. 验证通过后才允许提交报名请求

### 2.5 SQL注入防御

- **参数化查询**：所有数据库操作使用参数化查询，避免直接拼接SQL语句
- **ORM框架**：使用MyBatis/Hibernate等ORM框架，自动处理SQL注入防护
- **输入验证**：对用户输入进行严格验证，过滤特殊字符
- **权限控制**：数据库用户只授予必要的操作权限

## 3. 容灾与监控方案

### 3.1 服务冗余与负载均衡

- **服务冗余**：每个微服务至少部署3个实例，分布在不同的服务器上
- **负载均衡**：
  - API网关层：使用Nginx/Kong实现负载均衡
  - 微服务层：使用Ribbon/LoadBalancer实现服务间负载均衡
- **故障转移**：当某个服务实例故障时，自动将请求转发到其他健康实例

### 3.2 日志收集与监控系统

#### 3.2.1 日志收集
- **日志框架**：使用ELK Stack (Elasticsearch + Logstash + Kibana)
- **日志类型**：
  - 应用日志：记录系统运行状态和业务操作
  - 访问日志：记录用户请求和响应信息
  - 错误日志：记录系统异常和错误信息
- **日志处理流程**：
  1. 应用程序生成日志
  2. Logstash收集和处理日志
  3. Elasticsearch存储日志
  4. Kibana可视化展示日志

#### 3.2.2 监控告警
- **监控系统**：Prometheus + Grafana
- **监控指标**：
  - 服务指标：QPS、响应时间、错误率
  - 系统指标：CPU使用率、内存使用率、磁盘空间
  - 数据库指标：连接数、查询耗时、慢查询
  - 缓存指标：命中率、缓存大小、过期率
- **告警机制**：
  - 当指标超过阈值时，通过邮件、短信、企业微信等方式发送告警
  - 设置多级告警，区分严重程度

### 3.3 灰度发布与回滚

#### 3.3.1 灰度发布策略
- **发布方式**：蓝绿部署、金丝雀发布
- **流量分配**：
  - 初始阶段：10%流量导向新版本
  - 验证阶段：逐步增加流量至50%
  - 全量阶段：100%流量导向新版本
- **验证指标**：错误率、响应时间、用户反馈

#### 3.3.2 回滚机制
- **自动回滚**：当新版本错误率超过阈值时，自动回滚到旧版本
- **手动回滚**：通过发布平台手动执行回滚操作
- **回滚时间**：确保在5分钟内完成回滚操作

## 4. 技术栈选型

| 层级         | 技术选型                     | 版本      |
|--------------|------------------------------|-----------|
| 前端         | React/Vue                    | 18.x/3.x  |
| API网关      | Kong/Zuul                    | 3.x/2.x   |
| 微服务框架   | Spring Boot/Spring Cloud     | 3.x       |
| 服务注册发现 | Nacos/Eureka                 | 2.x/3.x   |
| 配置中心     | Nacos/Spring Cloud Config    | 2.x       |
| 消息队列     | Kafka/RabbitMQ               | 3.x/3.x   |
| 缓存         | Redis                        | 7.x       |
| 数据库       | MySQL                        | 8.x       |
| 分库分表     | ShardingSphere               | 5.x       |
| 日志系统     | ELK Stack                    | 8.x       |
| 监控系统     | Prometheus + Grafana         | 2.x/9.x   |

## 5. 总结

本架构设计文档详细说明了活动报名系统的架构设计、组件职责、数据库策略、性能优化和容灾监控方案。通过采用微服务架构、缓存策略、消息队列异步处理、限流和验证码机制等技术手段，系统能够应对高并发场景，保证系统的稳定性、可靠性和安全性。同时，通过完善的监控和容灾方案，能够及时发现和处理系统异常，确保系统的高可用性。