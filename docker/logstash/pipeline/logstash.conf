# Logstash Pipeline Configuration for Activity Registration System

input {
  # 从TCP端口接收日志（与微服务logback-spring.xml配置匹配）
  tcp {
    port => 5044
    type => "spring-boot"
    codec => json_lines
  }

  # 也可以从文件读取日志（可选）
  # file {
  #   path => ["/var/log/applogs/*.log"]
  #   type => "spring-boot"
  #   start_position => "beginning"
  #   codec => json_lines
  # }
}

filter {
  if [type] == "spring-boot" {
    # 解析Spring Boot日志格式
    json {
      source => "message"
      target => "log_fields"
      skip_on_invalid_json => true
    }

    # 提取重要字段
    mutate {
      rename => {
        "log_fields.level" => "level"
        "log_fields.logger_name" => "logger"
        "log_fields.thread_name" => "thread"
        "log_fields.message" => "message"
        "log_fields.stack_trace" => "stack_trace"
        "log_fields.timestamp" => "@timestamp"
      }
      remove_field => ["log_fields", "host", "port"]
    }

    # 添加环境标签
    mutate {
      add_field => {
        "environment" => "development"
        "project" => "activity-registration-system"
      }
    }

    # 根据日志级别添加标签
    if [level] == "ERROR" {
      mutate {
        add_tag => ["error", "critical"]
      }
    } else if [level] == "WARN" {
      mutate {
        add_tag => ["warning"]
      }
    } else if [level] == "INFO" {
      mutate {
        add_tag => ["info"]
      }
    }
  }
}

output {
  # 输出到Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "activity-registration-%{+YYYY.MM.dd}"
    document_type => "_doc"
    template_overwrite => true
  }

  # 输出到控制台（调试用）
  stdout {
    codec => rubydebug
  }
}